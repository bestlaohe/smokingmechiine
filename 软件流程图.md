# 智能焊接抽烟机软件流程图

## 1. 系统主流程图

```mermaid
flowchart TD
    Start([系统启动]) --> Init[系统初始化]
    Init --> CheckBat{检查电池电量}
    CheckBat -->|电量不足| LowPower[低电量提示]
    LowPower --> Sleep[进入省电模式]
    
    CheckBat -->|电量正常| MainLoop[进入主循环]
    
    MainLoop --> ReadInput[读取用户输入]
    ReadInput --> ProcessInput[处理输入事件]
    ProcessInput --> UpdateFan[更新风扇状态]
    UpdateFan --> UpdateLight[更新照明状态]
    UpdateLight --> UpdateUI[更新显示界面]
    UpdateUI --> CheckPower[检查电源状态]
    CheckPower --> MainLoop
    
    MainLoop -.->|长时间无操作| EnterSleep[进入睡眠模式]
    EnterSleep -.->|按键唤醒| WakeUp[唤醒系统]
    WakeUp --> MainLoop
```

## 2. 风扇控制流程

### 2.1 自动模式流程

```mermaid
flowchart TD
    Start([风扇自动模式]) --> ReadPM[读取PM2.5传感器值]
    ReadPM --> CalcLevel[计算烟雾等级]
    CalcLevel --> AdjustSpeed[调整风扇转速]
    AdjustSpeed --> SmallSmoke{烟雾浓度?}
    SmallSmoke -->|低浓度| LowSpeed[低速运行]
    SmallSmoke -->|中浓度| MidSpeed[中速运行]
    SmallSmoke -->|高浓度| HighSpeed[高速运行]
    LowSpeed --> UpdatePWM[更新PWM输出]
    MidSpeed --> UpdatePWM
    HighSpeed --> UpdatePWM
    UpdatePWM --> End([结束])
```

### 2.2 手动模式流程

```mermaid
flowchart TD
    Start([风扇手动模式]) --> ReadEncoder[读取编码器输入]
    ReadEncoder --> Direction{旋转方向?}
    Direction -->|顺时针| IncSpeed[增加风扇速度]
    Direction -->|逆时针| DecSpeed[降低风扇速度]
    Direction -->|未旋转| NoChange[保持当前速度]
    IncSpeed --> Limit{超出上限?}
    DecSpeed --> LimitLow{低于下限?}
    Limit -->|是| SetMax[设为最大速度]
    Limit -->|否| Apply[应用新速度]
    LimitLow -->|是| SetMin[设为最小速度]
    LimitLow -->|否| Apply
    NoChange --> Apply
    SetMax --> UpdatePWM[更新PWM输出]
    SetMin --> UpdatePWM
    Apply --> UpdatePWM
    UpdatePWM --> End([结束])
```

## 3. 灯光控制流程

```mermaid
flowchart TD
    Start([灯光控制]) --> ReadEncoder[读取编码器输入]
    ReadEncoder --> Direction{旋转方向?}
    Direction -->|顺时针| IncBright[增加亮度]
    Direction -->|逆时针| DecBright[降低亮度]
    Direction -->|未旋转| NoChange[保持当前亮度]
    
    IncBright --> Limit{超出上限?}
    DecBright --> LimitLow{低于下限?}
    
    Limit -->|是| SetMax[设为最大亮度]
    Limit -->|否| Fade[执行渐变过程]
    
    LimitLow -->|是| SetMin[设为最小亮度]
    LimitLow -->|否| Fade
    
    NoChange --> UpdatePWM[更新PWM输出]
    SetMax --> UpdatePWM
    SetMin --> UpdatePWM
    Fade --> UpdatePWM
    
    UpdatePWM --> End([结束])
```

## 4. 用户交互流程

### 4.1 按键处理流程

```mermaid
flowchart TD
    Start([按键处理]) --> Detect[检测按键状态]
    Detect --> IsPressed{按下?}
    IsPressed -->|否| End([结束])
    IsPressed -->|是| Duration{按下时长?}
    
    Duration -->|短按<0.5s| ShortPress[短按处理]
    Duration -->|长按>3s| LongPress[长按处理]
    
    ShortPress --> SwitchMode[切换控制模式]
    SwitchMode --> UpdateUI[更新UI显示]
    
    LongPress --> ResetParams[恢复默认参数]
    ResetParams --> UpdateUI
    
    UpdateUI --> End
```

### 4.2 编码器处理流程

```mermaid
flowchart TD
    Start([编码器处理]) --> ReadAB[读取A/B相状态]
    ReadAB --> Changed{状态变化?}
    Changed -->|否| End([结束])
    Changed -->|是| Direction{旋转方向?}
    
    Direction -->|顺时针| Mode{当前模式?}
    Direction -->|逆时针| Mode
    
    Mode -->|风扇模式| AdjustFan[调整风扇参数]
    Mode -->|灯光模式| AdjustLight[调整灯光参数]
    
    AdjustFan --> UpdateUI[更新UI显示]
    AdjustLight --> UpdateUI
    
    UpdateUI --> End
```

## 5. 电源管理流程

```mermaid
flowchart TD
    Start([电源管理]) --> ReadVoltage[读取电池电压]
    ReadVoltage --> CalcPercent[计算电池百分比]
    CalcPercent --> CheckStatus{检查状态}
    
    CheckStatus -->|充电中| ChargingMode[设置充电指示]
    CheckStatus -->|放电中| CheckLevel{检查电量}
    
    CheckLevel -->|>20%| Normal[正常工作]
    CheckLevel -->|10-20%| LowAlert[低电量提醒]
    CheckLevel -->|<10%| CriticalAlert[严重低电量]
    
    LowAlert --> FlashLED[闪烁指示灯]
    CriticalAlert --> EnterSaving[进入省电模式]
    
    ChargingMode --> UpdateUI[更新UI电量显示]
    Normal --> UpdateUI
    FlashLED --> UpdateUI
    EnterSaving --> UpdateUI
    
    UpdateUI --> End([结束])
```

## 6. 显示控制流程

```mermaid
flowchart TD
    Start([显示更新]) --> NeedUpdate{需要更新?}
    NeedUpdate -->|否| End([结束])
    NeedUpdate -->|是| ClearBuf[清除缓冲区]
    
    ClearBuf --> DrawFanBar[绘制风扇进度条]
    DrawFanBar --> DrawLightBar[绘制灯光进度条]
    DrawLightBar --> DrawBatteryBar[绘制电池进度条]
    
    DrawBatteryBar --> HighlightMode{当前控制模式?}
    HighlightMode -->|风扇模式| HighlightFan[高亮显示风扇项]
    HighlightMode -->|灯光模式| HighlightLight[高亮显示灯光项]
    
    HighlightFan --> SendToLCD[发送数据到显示屏]
    HighlightLight --> SendToLCD
    
    SendToLCD --> End
```

## 7. 软启动流程

```mermaid
flowchart TD
    Start([风扇软启动]) --> CurrentSpeed[获取当前速度]
    CurrentSpeed --> TargetSpeed[获取目标速度]
    TargetSpeed --> StepCalc[计算步进值]
    
    StepCalc --> Loop[循环增加]
    Loop --> ReachTarget{达到目标?}
    ReachTarget -->|否| IncSpeed[速度增加一步]
    IncSpeed --> Delay[短暂延时]
    Delay --> Loop
    ReachTarget -->|是| End([结束])
```

## 8. 错误处理流程

```mermaid
flowchart TD
    Start([错误处理]) --> CheckErr{错误类型?}
    
    CheckErr -->|电池电量低| LowBat[低电量处理]
    CheckErr -->|风扇堵转| FanStall[风扇堵转处理]
    CheckErr -->|传感器异常| SensorErr[传感器错误处理]
    CheckErr -->|系统异常| SysErr[系统异常处理]
    
    LowBat --> SaveEnergy[降低功耗]
    SaveEnergy --> AlertUser[提醒用户]
    
    FanStall --> StopFan[停止风扇]
    StopFan --> RestartFan[尝试重启风扇]
    RestartFan --> CheckRecover{恢复正常?}
    CheckRecover -->|是| Normal[恢复正常工作]
    CheckRecover -->|否| AlertUser
    
    SensorErr --> DefaultValue[使用默认值]
    DefaultValue --> AlertUser
    
    SysErr --> ResetSystem[重置系统]
    ResetSystem --> End([结束])
    
    AlertUser --> End
    Normal --> End
```

## 9. 初始化流程

```mermaid
flowchart TD
    Start([系统初始化]) --> SysClockInit[系统时钟初始化]
    SysClockInit --> GPIOInit[GPIO初始化]
    GPIOInit --> PWMInit[PWM初始化]
    PWMInit --> ADCInit[ADC初始化]
    ADCInit --> SPIInit[SPI初始化]
    SPIInit --> IntInit[中断初始化]
    
    IntInit --> DisplayInit[显示屏初始化]
    DisplayInit --> FanInit[风扇控制初始化]
    FanInit --> LightInit[照明控制初始化]
    LightInit --> UIInit[用户界面初始化]
    UIInit --> PowerInit[电源管理初始化]
    
    PowerInit --> SelfTest[系统自检]
    SelfTest --> TestResult{自检结果?}
    TestResult -->|正常| WelcomeScreen[显示欢迎界面]
    TestResult -->|异常| ErrorScreen[显示错误代码]
    
    WelcomeScreen --> DefaultParams[加载默认参数]
    ErrorScreen --> RetryInit[尝试重新初始化]
    RetryInit --> RetryResult{重试结果?}
    RetryResult -->|成功| DefaultParams
    RetryResult -->|失败| Error([进入错误状态])
    
    DefaultParams --> End([初始化完成])
```

## 10. 状态机流程

```mermaid
stateDiagram-v2
    [*] --> Init
    Init --> SelfTest
    SelfTest --> Idle : 自检通过
    SelfTest --> Error : 自检不通过
    
    Idle --> FanControl : 短按切换
    FanControl --> LightControl : 短按切换
    LightControl --> Idle : 短按切换
    
    Idle --> LowPower : 长时间无操作
    FanControl --> LowPower : 长时间无操作
    LightControl --> LowPower : 长时间无操作
    
    LowPower --> Idle : 按键唤醒
    
    Idle --> ChargingMode : 连接充电器
    FanControl --> ChargingMode : 连接充电器
    LightControl --> ChargingMode : 连接充电器
    
    ChargingMode --> Idle : 断开充电器
    
    FanControl --> AutoFan : 长按切换
    AutoFan --> ManualFan : 长按切换
    ManualFan --> FanControl : 长按切换
    
    Error --> Init : 重置系统
```

## 11. 总结

以上流程图全面覆盖了智能焊接抽烟机的软件工作流程，包括主要的控制逻辑、用户交互处理、错误处理以及各模块的详细工作流程。这些图表可以作为软件开发的指导，确保系统功能的完整实现。在实际开发过程中，可以根据硬件特性和用户反馈进行优化和调整。 