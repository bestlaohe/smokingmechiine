# 智能焊接抽烟机软件设计规范

## 1. 系统架构概述

本智能焊接抽烟机系统基于CH32V003微控制器（RISC-V架构），集成了风扇控制、LED照明控制、UI显示以及人机交互功能。系统采用模块化设计，各功能模块相对独立，便于维护和升级。

### 1.1 基本架构
```
┌───────────────────────────────────────────┐
│               应用层                       │
│  ┌─────────┐  ┌─────────┐  ┌───────────┐  │
│  │风扇控制 │  │照明控制 │  │人机交互   │  │
│  └─────────┘  └─────────┘  └───────────┘  │
├───────────────────────────────────────────┤
│               驱动层                       │
│  ┌─────────┐  ┌─────────┐  ┌───────────┐  │
│  │PWM驱动  │  │ADC驱动  │  │显示驱动   │  │
│  └─────────┘  └─────────┘  └───────────┘  │
├───────────────────────────────────────────┤
│               系统层                       │
│  ┌─────────┐  ┌─────────┐  ┌───────────┐  │
│  │定时器   │  │电源管理 │  │中断处理   │  │
│  └─────────┘  └─────────┘  └───────────┘  │
└───────────────────────────────────────────┘
```

## 2. 功能模块定义

### 2.1 风扇控制模块

#### 2.1.1 功能描述
- 提供双模式风扇控制：自动模式和手动无级调速模式
- 在自动模式下基于PM2.5传感器数据自动调节风扇转速
- 在手动模式下提供200-2000rpm范围内的无级调速
- 提供风扇速度软启动功能，避免瞬时电流过大

#### 2.1.2 接口定义
```c
// 风扇初始化
void FAN_Init(void);

// 设置风扇工作模式（0：自动模式，1：手动模式）
void FAN_SetMode(uint8_t mode);

// 设置风扇转速百分比（0-100%）
void FAN_SetSpeed(uint8_t percentage);

// 获取当前风扇转速百分比
uint8_t FAN_GetSpeed(void);

// 获取当前风扇工作模式
uint8_t FAN_GetMode(void);

// 风扇模块周期性处理函数（主循环中调用）
void FAN_Process(void);
```

### 2.2 照明控制模块

#### 2.2.1 功能描述
- 控制LED光源亮度，支持10%-100%无级调光
- 实现PWM调光，频率>1000Hz防频闪
- 提供渐亮/渐暗过渡效果

#### 2.2.2 接口定义
```c
// 照明系统初始化
void LIGHT_Init(void);

// 设置照明亮度百分比（10-100%）
void LIGHT_SetBrightness(uint8_t percentage);

// 获取当前照明亮度百分比
uint8_t LIGHT_GetBrightness(void);

// 设置渐变时间（单位：ms，0表示立即切换）
void LIGHT_SetFadeTime(uint16_t fadeTime);

// 照明模块周期性处理函数（主循环中调用）
void LIGHT_Process(void);
```

### 2.3 人机交互模块

#### 2.3.1 功能描述
- 实现按键检测和处理：短按切换控制模式，长按复位默认参数
- 实现旋转编码器输入检测
- 控制显示屏UI更新
- 提供低电量警告

#### 2.3.2 接口定义
```c
// 人机交互初始化
void HMI_Init(void);

// 按键处理函数
void HMI_KeyProcess(void);

// 编码器处理函数
void HMI_EncoderProcess(void);

// UI更新函数
void HMI_UpdateUI(void);

// 获取当前控制模式（0：风扇控制，1：灯光控制）
uint8_t HMI_GetControlMode(void);

// 人机交互模块周期性处理函数（主循环中调用）
void HMI_Process(void);
```

### 2.4 显示驱动模块

#### 2.4.1 功能描述
- 基于GC9107驱动芯片实现显示控制
- 提供基本图形绘制函数
- 显示进度条、文字和图标

#### 2.4.2 接口定义
```c
// 显示初始化
void DISP_Init(void);

// 清屏
void DISP_Clear(void);

// 绘制进度条
void DISP_DrawProgressBar(uint8_t x, uint8_t y, uint8_t width, uint8_t height, uint8_t percentage);

// 显示文字
void DISP_ShowString(uint8_t x, uint8_t y, char* str);

// 刷新显示
void DISP_Refresh(void);
```

### 2.5 电源管理模块

#### 2.5.1 功能描述
- 电池电量监测
- 充电状态监测
- 低功耗模式管理

#### 2.5.2 接口定义
```c
// 电源管理初始化
void POWER_Init(void);

// 获取电池电量百分比
uint8_t POWER_GetBatteryLevel(void);

// 获取充电状态（0：未充电，1：充电中，2：充电完成）
uint8_t POWER_GetChargeStatus(void);

// 进入低功耗模式
void POWER_EnterLowPower(void);

// 退出低功耗模式
void POWER_ExitLowPower(void);

// 电源管理周期性处理函数（主循环中调用）
void POWER_Process(void);
```

## 3. 引脚定义

### 3.1 CH32V003引脚分配

| 引脚号 | 引脚名称 | 功能定义           | 说明                         |
|--------|----------|--------------------|-----------------------------|
| 1      | PD4      | 风扇PWM输出        | PWM输出，控制风扇转速        |
| 2      | PD5      | PM2.5传感器输入    | ADC输入，检测PM2.5浓度       |
| 3      | PD6      | 旋转编码器A相      | 外部中断，检测编码器旋转     |
| 4      | PD7      | 旋转编码器B相      | GPIO输入，检测旋转方向       |
| 5      | PA1      | 功能按键输入       | 外部中断，检测按键按下       |
| 6      | PA2      | LED亮度控制        | PWM输出，控制LED亮度         |
| 7      | PC0      | 显示屏SPI_CS       | SPI片选信号                  |
| 8      | PC1      | 显示屏SPI_SCK      | SPI时钟信号                  |
| 9      | PC2      | 显示屏SPI_MOSI     | SPI数据输出                  |
| 10     | PC3      | 显示屏DC           | 数据/命令选择线              |
| 11     | PC4      | 显示屏RST          | 复位信号                     |
| 12     | PC5      | 电池电量检测       | ADC输入，检测电池电压        |
| 13     | PC6      | 充电状态检测       | GPIO输入，检测充电状态       |
| 14     | PC7      | 系统状态指示灯     | GPIO输出，指示系统状态       |

### 3.2 GC9107显示驱动芯片接口定义

| 引脚号 | 引脚名称 | 连接到MCU        | 说明                     |
|--------|----------|------------------|--------------------------|
| 1      | GND      | 系统地           | 电源地                   |
| 2      | VCC      | 3.3V电源         | 电源正极                 |
| 3      | SCL      | PC1 (SPI_SCK)    | SPI时钟信号              |
| 4      | SDA      | PC2 (SPI_MOSI)   | SPI数据信号              |
| 5      | RES      | PC4 (RST)        | 复位信号，低电平有效     |
| 6      | DC       | PC3 (DC)         | 数据/命令选择，高=数据，低=命令 |
| 7      | CS       | PC0 (SPI_CS)     | 片选信号，低电平有效     |
| 8      | BLK      | 系统VCC          | 背光控制，本设计常亮     |

## 4. 软件流程

### 4.1 主程序流程

```
开始
 │
 ├─ 系统初始化
 │   ├─ 时钟初始化
 │   ├─ GPIO初始化
 │   ├─ 中断初始化
 │   ├─ ADC初始化
 │   ├─ PWM初始化
 │   ├─ SPI初始化
 │   └─ 其他外设初始化
 │
 ├─ 功能模块初始化
 │   ├─ 风扇控制初始化
 │   ├─ 照明控制初始化
 │   ├─ 显示驱动初始化
 │   ├─ 人机交互初始化
 │   └─ 电源管理初始化
 │
 └─ 主循环
     │
     ├─ 处理按键输入
     ├─ 处理编码器输入
     ├─ 更新风扇状态
     ├─ 更新照明状态
     ├─ 更新电池状态
     ├─ 更新显示内容
     └─ 系统状态监测
```

### 4.2 中断服务流程

#### 4.2.1 按键中断
```
进入中断
 │
 ├─ 记录按键按下时间
 ├─ 消抖处理
 ├─ 设置按键事件标志
 └─ 退出中断
```

#### 4.2.2 编码器中断
```
进入中断
 │
 ├─ 读取B相状态
 ├─ 根据B相状态判断旋转方向
 ├─ 设置编码器事件标志
 └─ 退出中断
```

## 5. 软件参数配置

### 5.1 系统参数

| 参数名称         | 参数值       | 说明                           |
|------------------|--------------|--------------------------------|
| SYS_CLOCK        | 48MHz        | 系统时钟频率                   |
| TICK_TIME        | 1ms          | 系统基本时间单位               |
| ADC_SAMPLE_CYCLE | 100ms        | ADC采样周期                    |
| UI_UPDATE_CYCLE  | 200ms        | UI更新周期                     |
| BAT_CHECK_CYCLE  | 30s          | 电池电量检查周期               |

### 5.2 风扇控制参数

| 参数名称         | 参数值       | 说明                           |
|------------------|--------------|--------------------------------|
| FAN_PWM_FREQ     | 25KHz        | 风扇PWM频率                    |
| FAN_MIN_DUTY     | 10%          | 风扇最小占空比                 |
| FAN_MAX_DUTY     | 100%         | 风扇最大占空比                 |
| FAN_STARTUP_TIME | 500ms        | 风扇软启动时间                 |
| PM25_THRESHOLD_L | 25μg/m³      | PM2.5低阈值                    |
| PM25_THRESHOLD_H | 150μg/m³     | PM2.5高阈值                    |

### 5.3 照明控制参数

| 参数名称         | 参数值       | 说明                           |
|------------------|--------------|--------------------------------|
| LIGHT_PWM_FREQ   | 2KHz         | 照明PWM频率                    |
| LIGHT_MIN_DUTY   | 10%          | 照明最小占空比                 |
| LIGHT_MAX_DUTY   | 100%         | 照明最大占空比                 |
| LIGHT_FADE_STEP  | 2%           | 渐变步进值                     |

### 5.4 电源管理参数

| 参数名称         | 参数值       | 说明                           |
|------------------|--------------|--------------------------------|
| BAT_FULL_VOL     | 4.2V         | 电池满电电压                   |
| BAT_LOW_VOL      | 3.3V         | 电池低电电压                   |
| BAT_EMPTY_VOL    | 3.0V         | 电池空电电压                   |
| LOW_POWER_TIMEOUT| 5min         | 无操作进入低功耗模式时间       |

## 6. 开发工具及环境

- 开发环境：MounRiver Studio（基于Eclipse）
- 编译器：RISC-V GCC
- 调试器：WCH-Link
- 编程语言：C语言
- 固件库：CH32V003官方固件库

## 7. 版本管理

| 版本号 | 日期       | 说明                       |
|--------|------------|-----------------------------|
| V0.1   | 2023-09-01 | 初始版本，基本功能实现     |
| V0.2   | 2023-09-10 | 添加电源管理模块           |
| V0.3   | 2023-09-20 | 优化UI显示和人机交互体验   | 